<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Posto 1</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: 'Courier New', monospace;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-online {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        .status-offline {
            background: #e74c3c;
            box-shadow: 0 0 10px #e74c3c;
        }
        .message-container, .response-container {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .message, .response {
            background: #34495e;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        .message::before, .response::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(52, 152, 219, 0.1);
            transform-origin: top left;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .message.animate::before, .response.animate::before {
            transform: scaleX(1);
        }
        .message-header, .response-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #95a5a6;
            font-size: 0.9em;
        }
        .message-content, .response-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            position: relative;
            z-index: 1;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes envelope {
            0% { transform: scale(0.8) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .clear-btn {
            background: #e74c3c;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .clear-btn:hover {
            background: #c0392b;
        }
        /* Estilos para a seção de postos */
        .postos-container {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .posto-card {
            background: #34495e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        .posto-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .posto-nome {
            font-weight: bold;
            color: #3498db;
        }
        .posto-status {
            display: flex;
            align-items: center;
        }
        .posto-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-disponivel {
            background: #2ecc71;
            box-shadow: 0 0 5px #2ecc71;
        }
        .status-ocupado {
            background: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }
        .posto-info {
            margin-top: 10px;
            color: #95a5a6;
        }
        .posto-coordenadas {
            margin-top: 5px;
            font-size: 0.9em;
        }
        .posto-reservas {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #2c3e50;
        }
        .reserva-item {
            background: #2c3e50;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .envelope-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        .message:hover .envelope-icon, .response:hover .envelope-icon {
            opacity: 1;
            transform: scale(1.2);
        }
        /* Estilos para o pop-up da carta */
        .letter-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            background: #3498db;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: scale(0.5) rotate(-10deg);
            transition: all 0.3s ease;
        }

        .letter-popup.show {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .letter-icon {
            font-size: 2em;
            color: white;
            animation: letterAnimation 0.5s ease;
        }

        @keyframes letterAnimation {
            0% {
                transform: scale(0.5) rotate(-30deg);
            }
            50% {
                transform: scale(1.2) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        .letter-content {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 10px;
            transform: scale(0);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: #2c3e50;
            text-align: center;
            padding: 10px;
        }

        .letter-popup.show .letter-content {
            transform: scale(1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="status-indicator" id="statusIndicator"></span>
                Monitor do Posto 1
            </h1>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Mensagens Recebidas</h3>
                <div class="stat-value" id="messageCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Última Atividade</h3>
                <div class="stat-value" id="lastActivity">-</div>
            </div>
        </div>

        <!-- Seção de Postos -->
        <div class="postos-container">
            <h2>Postos Disponíveis</h2>
            <div id="lista-postos">
                <!-- Os postos serão inseridos aqui via JavaScript -->
            </div>
        </div>

        <!-- Seção de Mensagens -->
        <div class="message-container" id="messageContainer">
            <h3>Solicitações de Reserva</h3>
            <!-- As mensagens serão inseridas aqui -->
        </div>

        <!-- Nova seção de Respostas -->
        <div class="response-container" id="responseContainer">
            <h3>Respostas de Reserva</h3>
            <!-- As respostas serão inseridas aqui -->
        </div>

        <button class="clear-btn" onclick="clearMessages()">Limpar Mensagens</button>
    </div>

    <!-- Pop-up da carta -->
    <div class="letter-popup" id="letterPopup">
        <div class="letter-icon">✉</div>
        <div class="letter-content">
            Nova mensagem recebida!
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        let messageCount = 0;
        const messageContainer = document.getElementById('messageContainer');
        const responseContainer = document.getElementById('responseContainer');
        const statusIndicator = document.getElementById('statusIndicator');
        const messageCountElement = document.getElementById('messageCount');
        const lastActivityElement = document.getElementById('lastActivity');

        // Função para criar o card de um posto
        function criarCardPosto(posto) {
            const statusClass = posto.ocupado ? 'status-ocupado' : 'status-disponivel';
            const statusText = posto.ocupado ? 'Ocupado' : 'Disponível';
            
            let reservasHTML = '';
            if (posto.reservas && posto.reservas.length > 0) {
                reservasHTML = `
                    <div class="posto-reservas">
                        <h6>Reservas:</h6>
                        ${posto.reservas.map(reserva => `
                            <div class="reserva-item">
                                <strong>Cliente:</strong> ${reserva.cliente_id}<br>
                                <strong>Horário:</strong> ${reserva.horario}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <div class="posto-card">
                    <div class="posto-header">
                        <span class="posto-nome">${posto.nome}</span>
                        <span class="posto-status">
                            <span class="posto-status-indicator ${statusClass}"></span>
                            ${statusText}
                        </span>
                    </div>
                    <div class="posto-info">
                        <div class="posto-coordenadas">
                            <strong>Coordenadas:</strong> X: ${posto.x}, Y: ${posto.y}
                        </div>
                        ${reservasHTML}
                    </div>
                </div>
            `;
        }

        // Função para atualizar a lista de postos
        function atualizarListaPostos() {
            fetch('http://localhost:5002/postos', {
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(postos => {
                const container = document.getElementById('lista-postos');
                container.innerHTML = '';
                
                if (Object.keys(postos).length === 0) {
                    container.innerHTML = '<div class="posto-card">Nenhum posto disponível no momento.</div>';
                    return;
                }
                
                Object.entries(postos).forEach(([nome, dados]) => {
                    const posto = { nome, ...dados };
                    container.innerHTML += criarCardPosto(posto);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar postos:', error);
                const container = document.getElementById('lista-postos');
                container.innerHTML = '<div class="posto-card">Erro ao carregar postos. Tentando novamente...</div>';
            });
        }

        // Atualizar a lista de postos a cada 5 segundos
        setInterval(atualizarListaPostos, 5000);
        atualizarListaPostos(); // Primeira atualização

        // Conectar ao broker MQTT usando WebSocket
        const client = mqtt.connect('ws://localhost:9003');

        client.on('connect', () => {
            console.log('Conectado ao broker MQTT');
            statusIndicator.className = 'status-indicator status-online';
            
            // Inscrever nos tópicos
            client.subscribe('Solicitar/Reserva', (err) => {
                if (err) {
                    console.error('Erro ao inscrever em Solicitar/Reserva:', err);
                }
            });
            
            client.subscribe('Resposta/Reserva', (err) => {
                if (err) {
                    console.error('Erro ao inscrever em Resposta/Reserva:', err);
                }
            });
        });

        // Função para mostrar o pop-up da carta
        function showLetterPopup() {
            const popup = document.getElementById('letterPopup');
            popup.classList.add('show');
            
            // Remove o pop-up após 2 segundos
            setTimeout(() => {
                popup.classList.remove('show');
            }, 2000);
        }

        client.on('message', (topic, message) => {
            messageCount++;
            messageCountElement.textContent = messageCount;
            
            const timestamp = new Date().toLocaleTimeString();
            lastActivityElement.textContent = timestamp;

            // Mostra o pop-up da carta
            showLetterPopup();

            try {
                const dados = JSON.parse(message.toString());
                const container = topic === 'Solicitar/Reserva' ? messageContainer : responseContainer;
                const messageElement = document.createElement('div');
                messageElement.className = topic === 'Solicitar/Reserva' ? 'message' : 'response';
                
                messageElement.innerHTML = `
                    <div class="${topic === 'Solicitar/Reserva' ? 'message' : 'response'}-header">
                        <span>Cliente ID: ${dados.cliente_id}</span>
                        <span>${timestamp}</span>
                    </div>
                    <div class="${topic === 'Solicitar/Reserva' ? 'message' : 'response'}-content">
                        ${topic === 'Solicitar/Reserva' ? `
Data: ${dados.data}
Serviço: ${dados.servico}
Timestamp: ${new Date(dados.timestamp).toLocaleString()}
                        ` : `
Status: ${dados.status}
Mensagem: ${dados.mensagem}
Postos Reservados: ${dados.postos_reservados ? dados.postos_reservados.join(', ') : 'Nenhum'}
Timestamp: ${new Date(dados.timestamp).toLocaleString()}
                        `}
                    </div>
                `;
                
                container.insertBefore(messageElement, container.children[1]);
                
                setTimeout(() => {
                    messageElement.classList.add('animate');
                }, 100);
                
            } catch (e) {
                console.error('Erro ao processar mensagem:', e);
            }
        });

        client.on('error', (err) => {
            console.error('Erro na conexão:', err);
            statusIndicator.className = 'status-indicator status-offline';
        });

        client.on('close', () => {
            console.log('Conexão fechada');
            statusIndicator.className = 'status-indicator status-offline';
        });

        function clearMessages() {
            messageContainer.innerHTML = '<h3>Solicitações de Reserva</h3>';
            responseContainer.innerHTML = '<h3>Respostas de Reserva</h3>';
            messageCount = 0;
            messageCountElement.textContent = '0';
            lastActivityElement.textContent = '-';
        }
    </script>
</body>
</html> 